#!/bin/bash

set -euo pipefail

ARCH="@ARCH@"
CXX_LIB="@CXX_LIB@"

CPU_COUNT=$(sysctl -n hw.activecpu)
CPU_GHZ=$(echo "scale=2; $(sysctl -n hw.cpufrequency) / 10 ^ 9" | bc | sed -e '/\./s/0*$//' -e 's/\.$//')
RAM_GB=$(echo "scale=2; $(sysctl -n hw.memsize) / 2 ^ 30" | bc | sed -e '/\./s/0*$//' -e 's/\.$//')
BOOT_DATE=$(date -u -j -f "%b %d %H:%M:%S" "$(LC_TIME=C TZ=Z who -b | sed -E -e 's/ +$//' -e 's/^([^ ]+ +){2}//'):00" "+%Y-%m-%dT%H:%M:%SZ")

MACOS_VERSION=$(sw_vers -productVersion)
MACOS_BUILD=$(sw_vers -buildVersion)
case "$(cut -d. -f1-2 <<< "$MACOS_VERSION")" in
    10.0)   MACOS_NAME="Mac OS X Cheetah";;
    10.1)   MACOS_NAME="Mac OS X Puma";;
    10.2)   MACOS_NAME="Mac OS X Jaguar";;
    10.3)   MACOS_NAME="Mac OS X Panther";;
    10.4)   MACOS_NAME="Mac OS X Tiger";;
    10.5)   MACOS_NAME="Mac OS X Leopard";;
    10.6)   MACOS_NAME="Mac OS X Snow Leopard";;
    10.7)   MACOS_NAME="Mac OS X Lion";;
    10.8)   MACOS_NAME="OS X Mountain Lion";;
    10.9)   MACOS_NAME="OS X Mavericks";;
    10.10)  MACOS_NAME="OS X Yosemite";;
    10.11)  MACOS_NAME="OS X El Capitan";;
    10.12)  MACOS_NAME="macOS Sierra";;
    10.13)  MACOS_NAME="macOS High Sierra";;
    10.14)  MACOS_NAME="macOS Mojave";;
    *)      MACOS_NAME="macOS"
esac

XCODE_VERSION=$(xcodebuild -version | sed -E -n 's/^Xcode //p')
XCODE_BUILD=$(xcodebuild -version | sed -E -n 's/^[Bb]uild ?[Vv]ersion:? //p')

if [ -x /usr/bin/clang ]; then
  CLANG_VERSION=$(/usr/bin/clang --version | head -n 1)
else
  CLANG_VERSION=
fi

echo "$MACOS_NAME v$MACOS_VERSION ($MACOS_BUILD)"
echo "Xcode v$XCODE_VERSION ($XCODE_BUILD)"
[ -n "$CLANG_VERSION" ] && echo "$CLANG_VERSION"
echo "Architecture: $ARCH"
echo "C++ library: $CXX_LIB"
echo "CPU: $CPU_COUNT â¨‰ $CPU_GHZ GHz"
echo "RAM: $RAM_GB GB"
echo "Boot date: $BOOT_DATE"
